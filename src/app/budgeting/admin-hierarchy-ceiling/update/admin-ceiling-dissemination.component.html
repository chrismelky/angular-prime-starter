<script src="admin-ceiling-dissemination.component.ts"></script>
<div class="ui-dialog-content">
  <div class="content" fxLayout="column" fxLayoutGap="0.75rem">
    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
      <span class="card-header-text"><b style="font-size:16px">Revenue Source : {{this.ceiling?.ceiling?.fund_source?.gfs_code?.name}}</b></span>
    </div>
    <div class="overlay-position"><span #overlayTarget></span></div>
    <div fxLayout="column" fxLayoutGap="10px">
      <div fxLayout="row wrap" fxLayoutGap="10px">
        <div fxLayout="row wrap" fxLayoutGap="0.75rem" fxFlex fxLayoutAlign="start center">
          <div *ngFor="let ceiling of councilCeilingGroup" class="p-field" fxFlex>
               <span class="p-float-label">
                  <div  fxLayout="row" fxLayoutAlign="space-between center">
                    <span><b>{{ceiling.label}}</b></span>
                    <span ><b [className]="(((ceiling.chain.next?totalAllocatedCeiling[ceiling.position].amount:totalFacilityAllocatedAmount)
                      >0?((ceiling.chain.next?totalAllocatedCeiling[ceiling.position].amount:totalFacilityAllocatedAmount)/(ceiling.chain.next?defaultSelected![ceiling.position].amount:finalCeiling.amount))*100:0.00
                    ))===100?'success':'error'">{{ (ceiling.chain.next?totalAllocatedCeiling[ceiling.position].amount:totalFacilityAllocatedAmount)
                      | currency:"TZS":"TSH"}} ({{((ceiling.chain.next?totalAllocatedCeiling[ceiling.position].amount:totalFacilityAllocatedAmount)
                      >0?((ceiling.chain.next?totalAllocatedCeiling[ceiling.position].amount:totalFacilityAllocatedAmount)/(ceiling.chain.next?defaultSelected![ceiling.position].amount:finalCeiling.amount))*100:0.00
                    ) | number : '1.2-2'}})%</b>Allocated</span>
                  </div>
                </span>
            <p-dropdown
              optionValue=""
              optionLabel="section.name"
              [autoDisplayFirst]="true"
              [(ngModel)]="defaultSelected![ceiling.position]"
              placeholder="Select  {{ceiling.label}}"
              [filter]="true"
              [options]="ceiling.ceiling!"
              (onChange)="sectionChange($event.value,ceiling.chain)"
              styleClass="form-control"
            >
              <ng-template let-item pTemplate="item">
                <div fxLayout="row" fxLayoutAlign="space-between center">
                  <span class=""> {{item.section.name}} </span>
                  <span *ngIf="section_level_position! <= item.section.position! && !item.is_locked" class="">&nbsp;&nbsp; <b>{{item.amount | currency:"TZS":"TSH"}}</b> &nbsp;&nbsp; <p-badge (click)="allocateCeiling(ceiling.position,op,$event,item,ceiling.chain)" *ngIf="ceiling.chain.next" [value]="'Allocate'" styleClass="p-mr-2"></p-badge></span>
                </div>
              </ng-template>
              <ng-template let-item pTemplate="selectedItem">
                <span class=""> {{item.section.name}}</span>
                <span *ngIf="section_level_position! <= item.section.position!" class="">&nbsp;&nbsp; <b>{{item.amount | currency:"TZS":"TSH"}}</b></span>
              </ng-template>
            </p-dropdown>
          </div>
        </div>
      </div>
    </div>
    <br>
    <div fxLayout="column" fxLayoutGap="10px">
      <div fxLayout="row wrap" fxLayoutGap="10px">
        <div fxLayout="row wrap" fxLayoutGap="0.75rem" fxFlex fxLayoutAlign="start center">
          <div class="p-field" fxFlex>
            <p-table
              #fc
              class="ceiling"
              [value]="facilityCeiling!"
              [scrollable]="true"
              scrollHeight="35vh"
              dataKey="id"
              editMode="row"
              [globalFilterFields]="['council','facility']"
              dataKey="id"
            >
              <ng-template pTemplate="caption">
                <span><b>{{finalCeiling?.section?.name}} Allocation</b></span>
                <br>
                <div fxLayout="column" fxLayoutGap="10px">
                  <div fxLayout="row wrap" fxLayoutGap="10px">
                    <div fxLayout="row" fxLayoutGap="0.75rem" fxFlex fxLayoutAlign="start center">
                      <div class="p-field" fxFlex>
                  <span class="p-input-icon-left" style="width: 100%">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (ngModelChange)="fc.filterGlobal($event, 'contains')" [(ngModel)]="facilityFilterValue" placeholder="Search..." />
                </span>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
              <ng-template pTemplate="header" >
                <tr *ngIf="totalFacilityAllocatedAmount! > finalCeiling?.amount">
                  <th colspan="4">
                    <span><b style="color: red">Allocation Exceed Ceiling No Change Will Be saved !</b></span>
                  </th>
                </tr>
                <tr>
                  <th>Council</th>
                  <th>Facility</th>
                  <th class="end">Amount (TSH)</th>
                  <th class="end">%</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-rowData let-editing="editing" let-rowIndex="rowIndex" let-columns="columns">
                <tr>
                  <td>{{rowData?.council}}</td>
                  <td>{{rowData?.facility}}</td>
                  <td>
                    <div  class="p-field" fxFlex style="text-align: end;">
                      <span *ngIf="finalCeiling.amount <=0 || rowData.is_locked">
                        {{rowData!.amount | currency:"TZS":"TSH"}}
                      </span>
                      <p-inputNumber
                        *ngIf="finalCeiling.amount > 0 && !rowData.is_locked"
                        mode="decimal"
                        prefix="TSH "
                        [(ngModel)]="rowData!.amount"
                        [minFractionDigits]="2"
                        [maxFractionDigits]="2"
                        (onBlur)="updateFacilityCeiling(rowData)"
                        (onInput)="facilityCeilingChange(rowData,$event.value)"
                        [min]="0"
                      ></p-inputNumber>
                    </div>
                  </td>
                  <td >
                    <div  class="p-field" fxFlex style="text-align: end;">
                      <span *ngIf="finalCeiling.amount <=0 || rowData.is_locked">
                        {{rowData!.percent | number : '1.2-2'}} %
                      </span>
                      <p-inputNumber
                        *ngIf="finalCeiling.amount > 0  && !rowData.is_locked"
                        mode="decimal"
                        suffix=" %"
                        [(ngModel)]="rowData.percent"
                        [minFractionDigits]="2"
                        [maxFractionDigits]="2"
                        (onBlur)="updateFacilityCeiling(rowData)"
                        (onInput)="getFacilityPercent(rowData,$event.value)"
                        [min]="0"
                        [max]="100"
                      ></p-inputNumber>
                    </div>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage"> No Ceiling Found </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="p-dialog-footer" style="bottom: 0">
  <p-button (click)="close()"  label="Save & Close" icon="pi pi-save"></p-button>
</div>

<p-overlayPanel
  appendTo="body"
  #op
  id="overlay"
  [showCloseIcon]="true"
  [dismissable]="false"
  [focusOnShow]="false"
  [style]="marginStyle"
>
  <div class="dialog-content" style="overflow: auto">
    <div class="card">
      <p-table
        #c
        class="ceiling"
        [value]="toAllocate!"
        [scrollable]="true"
        scrollHeight="32vh"
        dataKey="id"
        editMode="row"
        [globalFilterFields]="['admin_hierarchy.name','section.name']"
      >
        <ng-template pTemplate="caption">
          <span><b>{{selectedCeiling[allocationPosition!]?.section?.name!}} Allocation</b></span>
          <br>
          <div fxLayout="column" fxLayoutGap="10px">
            <div fxLayout="row wrap" fxLayoutGap="10px">
              <div fxLayout="row" fxLayoutGap="0.75rem" fxFlex fxLayoutAlign="start center">
                <div class="p-field" fxFlex>
                  <span class="p-input-icon-left" style="width: 100%">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (ngModelChange)="c.filterGlobal($event, 'contains')" [(ngModel)]="filterValue" placeholder="Search..." />
                </span>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
        <ng-template pTemplate="header" >
          <tr>
            <th colspan="4" *ngIf="(totalAllocatedCeiling[allocationPosition!]?.amount) > selectedCeiling![allocationPosition!]?.amount!">
              <span><b style="color: red">Allocation Exceed Ceiling No Change Will Be saved !</b></span>
            </th>
          </tr>
          <tr>
            <th>Council</th>
            <th>{{toAllocate!.length>0?toAllocate![0]?.section?.section_level?.name:null}}</th>
            <th class="end">Amount (TSH)</th>
            <th class="end">%</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowData  let-rowIndex="rowIndex" let-columns="columns">
          <tr>
            <td>{{rowData?.admin_hierarchy.name}}</td>
            <td>{{rowData?.section?.name}}</td>
            <td  styleClass="col-button">
              <div  class="p-field" fxFlex style="text-align: end;">
                      <span *ngIf="rowData.is_locked">
                        {{rowData!.amount | currency:"TZS":"TSH"}}
                      </span>
                    <p-inputNumber
                      *ngIf="!rowData.is_locked"
                      mode="decimal"
                      prefix="TSH "
                      [(ngModel)]="rowData!.amount"
                      [minFractionDigits]="2"
                      [maxFractionDigits]="2"
                      (onBlur)="updateCeiling(rowData)"
                      (onInput)="ceilingChange(rowData,$event.value)"
                      [min]="0"
                    ></p-inputNumber>
              </div>
            </td>
            <td>
              <div  class="p-field" fxFlex style="text-align: end;">
                <span *ngIf="rowData.is_locked">
                  {{rowData!.amount | currency:"TZS":"TSH"}}
                </span>
                <p-inputNumber
                  *ngIf="!rowData.is_locked"
                mode="decimal"
                suffix=" %"
                [(ngModel)]="rowData.percent"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
                (onBlur)="updateCeiling(rowData)"
                (onInput)="getPercent(rowData,$event.value)"
                [min]="0"
                [max]="100"
              ></p-inputNumber>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage"> No Ceiling Found </ng-template>
      </p-table>
    </div>
  </div>
</p-overlayPanel>
