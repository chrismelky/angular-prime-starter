<div class="dialog-content">
  <app-loader
    [isLoading]="
      isSaving ||
      fundSourceIsLoading ||
      taskNatureIsLoading ||
      projectIsLoading ||
      projectOutputIsLoading ||
      facilityIsLoading ||
      budgetClassIsLoading ||
      referenceIsLoading ||
      responsibleIsLoading ||
      categoryIsLoading
    "
  ></app-loader>

  <div fxLayout="column" fxLayoutGap="10px">
    <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
      <button
        icon="pi pi-clone"
        pButton
        type="button"
        class="p-button-sm p-button-outlined"
        label="Generic Activity"
        (click)="genericActivityPanel.toggle($event)"
      ></button>
    </div>
    <form
      name="generalForm"
      role="form"
      novalidate
      (ngSubmit)="save()"
      [formGroup]="generalForm"
    >
      <mat-stepper #stepper [linear]="true">
        <ng-template matStepperIcon="edit">
          <i
            class="pi pi-pencil"
            style="font-size: 11px; line-height: 11px"
          ></i>
        </ng-template>
        <ng-template matStepperIcon="error">
          <i
            class="pi pi-exclamation-triangle"
            style="font-size: 14px; line-height: 14px"
          ></i>
        </ng-template>

        <mat-step
          [stepControl]="generalForm"
          errorMessage="This step incomplete"
        >
          <ng-template matStepLabel>General</ng-template>

          <div fxLayout="column" fxLayoutGap="20px">
            <!-- Description field -->
            <div class="p-field" fxFlex>
              <span class="p-float-label">
                <input
                  id="description"
                  formControlName="description"
                  pInputText
                />
                <label for="description">Description </label>
              </span>
              <span
                *ngIf="
                  generalForm.get('description')!.invalid &&
                  (generalForm.get('description')!.dirty ||
                    generalForm.get('description')!.touched ||
                    formError)
                "
              >
                <small
                  class="p-error"
                  *ngIf="generalForm.get('description')?.errors?.required"
                  >Description is required.</small
                >
              </span>
            </div>
            <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="center">
              <!-- Main Budget class -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    #mainBudgetClass
                    id="main_budget_class_id"
                    appendTo="body"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    formControlName="main_budget_class_id"
                    [options]="mainBudgetClasses!"
                    (onChange)="loadBudgetClasses(mainBudgetClass.value)"
                    optionValue="id"
                    optionLabel="name"
                    class="p-inputtext-sm"
                  ></p-dropdown>
                  <label for="main_budget_class_id">Budget Class </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('main_budget_class_id')!.invalid &&
                    (generalForm.get('main_budget_class_id')!.dirty ||
                      generalForm.get('main_budget_class_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('main_budget_class_id')?.errors?.required
                    "
                    >Budget Class is required.</small
                  >
                </span>
              </div>

              <!-- Sub  Budget class -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    #budgetClass
                    id="budget_class_id"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    formControlName="budget_class_id"
                    [options]="budgetClasses!"
                    optionValue="id"
                    (onChange)="loadFundSources(budgetClass.value, true)"
                    optionLabel="name"
                    class="p-inputtext-sm"
                  ></p-dropdown>
                  <label for="budget_class_id">Sub Budget Class </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('budget_class_id')!.invalid &&
                    (generalForm.get('budget_class_id')!.dirty ||
                      generalForm.get('budget_class_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('budget_class_id')?.errors?.required"
                    >Sub Budget Class is required.</small
                  >
                </span>
              </div>

              <!-- Project -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    #project
                    id="project_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    [options]="projects!"
                    (onChange)="updateProjectTypeValidation(project.value)"
                    formControlName="project_id"
                  >
                    <ng-template let-project pTemplate="item">
                      <span>[ {{ project.code }} ] {{ project.name }}</span>
                    </ng-template>
                  </p-dropdown>
                  <label for="project_id">Project </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('project_id')!.invalid &&
                    (generalForm.get('project_id')!.dirty ||
                      generalForm.get('project_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('project_id')?.errors?.required"
                    >Project is required.</small
                  >
                </span>
              </div>
            </div>
            <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
              <!-- Activity type -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    #activityType
                    id="activity_type_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    (onChange)="loadActivityTaskNature(activityType.value)"
                    [options]="activityTypes!"
                    formControlName="activity_type_id"
                  ></p-dropdown>
                  <label for="activity_type_id">Activity Type </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('activity_type_id')!.invalid &&
                    (generalForm.get('activity_type_id')!.dirty ||
                      generalForm.get('activity_type_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('activity_type_id')?.errors?.required
                    "
                    >Activity Type is required.</small
                  >
                </span>
              </div>
              <!-- Activity task nature -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    id="activity_task_nature_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    [options]="activityTaskNatures!"
                    formControlName="activity_task_nature_id"
                  ></p-dropdown>
                  <label for="activity_task_nature_id"
                    >Activity Task Nature
                  </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('activity_task_nature_id')!.invalid &&
                    (generalForm.get('activity_task_nature_id')!.dirty ||
                      generalForm.get('activity_task_nature_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('activity_task_nature_id')?.errors
                        ?.required
                    "
                    >Activity Task Nature is required.</small
                  >
                </span>
              </div>

              <!-- Responsible perdion -->
              <div
                fxLayout="row"
                fxFlex
                fxLayoutGap="0px"
                fxLayoutAlign="start center"
              >
                <div class="p-field" fxFlex>
                  <span class="p-float-label">
                    <p-dropdown
                      id="responsible_person_id"
                      optionValue="id"
                      optionLabel="name"
                      [autoDisplayFirst]="false"
                      [filter]="true"
                      class="p-inputtext-sm"
                      appendTo="body"
                      [options]="responsiblePeople!"
                      formControlName="responsible_person_id"
                    ></p-dropdown>
                    <label for="responsible_person_id"
                      >Responsible Person
                    </label>
                  </span>
                  <span
                    *ngIf="
                      generalForm.get('responsible_person_id')!.invalid &&
                      (generalForm.get('responsible_person_id')!.dirty ||
                        generalForm.get('responsible_person_id')!.touched ||
                        formError)
                    "
                  >
                    <small
                      class="p-error"
                      *ngIf="
                        generalForm.get('responsible_person_id')?.errors
                          ?.required
                      "
                      >Responsible Person is required.</small
                    >
                  </span>
                </div>
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  (click)="createResponsiblePerson()"
                  pTooltip="Add responsible  person"
                  class="p-button p-button-text p-icon-only"
                ></button>
              </div>
            </div>
            <div fxLayout="column" fxLayoutGap="2px">
              <div
                fxLayout="row"
                fxLayoutGap="20px"
                fxLayoutAlign="space-between"
              >
                <!-- Period Onde field -->
                <p-checkbox
                  name="q1"
                  [value]="true"
                  label="Q1"
                  [binary]="true"
                  (onChange)="updatePeriodValidity()"
                  formControlName="period_one"
                ></p-checkbox>
                <p-checkbox
                  name="q2"
                  [binary]="true"
                  (onChange)="updatePeriodValidity()"
                  [value]="true"
                  label="Q2"
                  formControlName="period_two"
                ></p-checkbox>
                <p-checkbox
                  name="q3"
                  (onChange)="updatePeriodValidity()"
                  [value]="true"
                  [binary]="true"
                  label="Q3"
                  formControlName="period_three"
                ></p-checkbox>
                <p-checkbox
                  name="q4"
                  [value]="true"
                  (onChange)="updatePeriodValidity()"
                  [binary]="true"
                  label="Q4"
                  formControlName="period_four"
                ></p-checkbox>
              </div>
              <small
                class="p-error"
                *ngIf="formError && generalForm.get('period')?.errors?.required"
                >At least one Quarter is required.</small
              >
            </div>

            <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <input
                    id="indicator"
                    formControlName="indicator"
                    pInputText
                  />
                  <label for="indicator">Indicator </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('indicator')!.invalid &&
                    (generalForm.get('indicator')!.dirty ||
                      generalForm.get('indicator')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('indicator_value')?.errors?.required"
                    >Activity Indicator is required.</small
                  >
                </span>
              </div>

              <div class="p-field" fxFlex="100px">
                <span class="p-float-label">
                  <p-inputNumber
                    [minFractionDigits]="2"
                    mode="decimal"
                    id="indicator_value"
                    formControlName="indicator_value"
                  >
                  </p-inputNumber>
                  <label for="indicator_value">Indicator Value </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('indicator_value')!.invalid &&
                    (generalForm.get('indicator_value')!.dirty ||
                      generalForm.get('indicator_value')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('indicator_value')?.errors?.required"
                    >Value is required.</small
                  >
                </span>
              </div>
            </div>

            <div
              *ngIf="projectTypeRequired"
              fxLayout="row"
              fxLayoutGap="10px"
              fxLayoutAlign="start"
            >
              <!-- Project Type -->
              <div class="p-field" fxFlex="0 1 30%">
                <span class="p-float-label">
                  <p-dropdown
                    #projectType
                    id="project_type_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    [options]="projectTypes!"
                    (onChange)="loadExpenditureCategory(projectType.value)"
                    formControlName="project_type_id"
                  ></p-dropdown>
                  <label for="project_type_id">Project Type</label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('project_type_id')!.invalid &&
                    (generalForm.get('project_type_id')!.dirty ||
                      generalForm.get('project_type_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('project_type_id')?.errors?.required"
                    >Project Type is required.</small
                  >
                </span>
              </div>
              <!-- Expenditure Type -->
              <div class="p-field" fxFlex="0 1 30%">
                <span class="p-float-label">
                  <p-dropdown
                    #expenditureCategory
                    id="expenditure_category_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    (onChange)="loadProjectOutput(expenditureCategory.value)"
                    [options]="expenditureCategories!"
                    formControlName="expenditure_category_id"
                  ></p-dropdown>
                  <label for="expenditure_category_id"
                    >Expenditure Category</label
                  >
                </span>
                <span
                  *ngIf="
                    generalForm.get('expenditure_category_id')!.invalid &&
                    (generalForm.get('expenditure_category_id')!.dirty ||
                      generalForm.get('expenditure_category_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('expenditure_category_id')?.errors
                        ?.required
                    "
                    >Expenditure Category is required.</small
                  >
                </span>
              </div>
              <!-- Project output-->
              <div class="p-field" fxFlex="0 1 30%">
                <span class="p-float-label">
                  <p-dropdown
                    id="project_output_id"
                    optionValue="id"
                    optionLabel="name"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    [options]="projectOutputs!"
                    formControlName="project_output_id"
                  ></p-dropdown>
                  <label for="project_output_id">Project Output</label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('project_output_id')!.invalid &&
                    (generalForm.get('project_output_id')!.dirty ||
                      generalForm.get('project_output_id')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('project_output_id')?.errors?.required
                    "
                    >Project output is required.</small
                  >
                </span>
              </div>
              <!-- Project output value-->

              <div class="p-field" fxFlex="0 1 10%">
                <span class="p-float-label">
                  <p-inputNumber
                    [minFractionDigits]="2"
                    mode="decimal"
                    id="project_output_value"
                    formControlName="project_output_value"
                  >
                  </p-inputNumber>
                  <label for="project_output_value">Value </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('project_output_value')!.invalid &&
                    (generalForm.get('project_output_value')!.dirty ||
                      generalForm.get('project_output_value')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="
                      generalForm.get('project_output_value')?.errors?.required
                    "
                    >Output Value</small
                  >
                </span>
              </div>
            </div>

            <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
              <!-- Fund source -->
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-multiSelect
                    id="fund_sources"
                    [filter]="true"
                    display="chip"
                    dataKey="id"
                    formControlName="fund_sources"
                    [options]="fundSources!"
                    optionLabel="name"
                    class="p-inputtext-sm"
                    appendTo="body"
                  ></p-multiSelect>
                  <label for="fund_sources">
                    <span>Fund Sources </span>
                  </label>
                </span>
                <span
                  *ngIf="
                    generalForm.get('fund_sources')!.invalid &&
                    (generalForm.get('fund_sources')!.dirty ||
                      generalForm.get('fund_sources')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="generalForm.get('fund_sources')?.errors?.required"
                    >Fund Sources are required.</small
                  >
                </span>
              </div>
            </div>

            <div fxLayout="row" fxLayoutGap="0.75rem">
              <span fxFlex></span>
              <button
                (click)="formError = true"
                matStepperNext
                class="p-button-text"
                icon="pi pi-arrow-right"
                iconPos="right"
                label="Next"
                pButton
                type="button"
              ></button>
            </div>
          </div>
        </mat-step>
        <!-- Reference Tab -->
        <mat-step [stepControl]="referenceForm">
          <div fxLayout="column" fxLayoutGap="20px">
            <form
              name="referenceForm"
              role="form"
              novalidate
              [formGroup]="referenceForm"
            >
              <ng-template matStepLabel>References</ng-template>
              <div fxLayout="column" fxLayoutGap="20px">
                <div fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="start">
                  <p-divider fxFlex class="title" align="center">
                    <small>Priority Areas</small>
                  </p-divider>
                  <!-- Priority area -->
                  <div class="p-field" fxFlex>
                    <span class="p-float-label">
                      <p-dropdown
                        #priorityArea
                        id="priority_area_id"
                        optionValue="id"
                        optionLabel="description"
                        [autoDisplayFirst]="false"
                        [filter]="true"
                        class="p-inputtext-sm"
                        appendTo="body"
                        (onChange)="
                          loadInterventionAndSectorProblem(priorityArea.value)
                        "
                        [options]="priorityAreas!"
                        formControlName="priority_area_id"
                      ></p-dropdown>
                      <label for="priority_area_id">Priority Area </label>
                    </span>
                    <span
                      *ngIf="
                        referenceForm.get('priority_area_id')!.invalid &&
                        (referenceForm.get('priority_area_id')!.dirty ||
                          referenceForm.get('priority_area_id')!.touched ||
                          formError)
                      "
                    >
                      <small
                        class="p-error"
                        *ngIf="
                          referenceForm.get('priority_area_id')?.errors
                            ?.required
                        "
                        >Priority Area is required.</small
                      >
                    </span>
                  </div>

                  <!-- Intevention -->
                  <div class="p-field" fxFlex>
                    <span class="p-float-label">
                      <p-dropdown
                        id="intervention_id"
                        optionValue="id"
                        optionLabel="description"
                        [autoDisplayFirst]="false"
                        [filter]="true"
                        class="p-inputtext-sm"
                        appendTo="body"
                        [options]="interventions!"
                        formControlName="intervention_id"
                      ></p-dropdown>
                      <label for="intervention_id">Intervention </label>
                    </span>
                    <span
                      *ngIf="
                        referenceForm.get('intervention_id')!.invalid &&
                        (referenceForm.get('intervention_id')!.dirty ||
                          referenceForm.get('intervention_id')!.touched ||
                          formError)
                      "
                    >
                      <small
                        class="p-error"
                        *ngIf="
                          referenceForm.get('intervention_id')?.errors?.required
                        "
                        >Intervention is required.</small
                      >
                    </span>
                  </div>

                  <!-- Sector problem -->
                  <div class="p-field" fxFlex>
                    <span class="p-float-label">
                      <p-dropdown
                        id="sector_problem_id"
                        optionValue="id"
                        optionLabel="description"
                        [autoDisplayFirst]="false"
                        [filter]="true"
                        class="p-inputtext-sm"
                        appendTo="body"
                        [options]="sectorProblems!"
                        formControlName="sector_problem_id"
                      ></p-dropdown>
                      <label for="sector_problem_id">Sector Problem </label>
                    </span>
                    <span
                      *ngIf="
                        referenceForm.get('sector_problem_id')!.invalid &&
                        (referenceForm.get('sector_problem_id')!.dirty ||
                          referenceForm.get('sector_problem_id')!.touched ||
                          formError)
                      "
                    >
                      <small
                        class="p-error"
                        *ngIf="
                          referenceForm.get('sector_problem_id')?.errors
                            ?.required
                        "
                        >Sector Problem is required.</small
                      >
                    </span>
                  </div>
                </div>

                <div
                  formArrayName="references"
                  fxLayout="column"
                  fxLayoutGap="10px"
                  fxLayoutAlign="start wrap"
                >
                  <div
                    *ngIf="referenceLoading"
                    fxLayout="row"
                    fxLayoutGap="20px"
                    fxLayoutAlign="center center"
                  >
                    <i
                      class="pi pi-spin pi-spinner"
                      style="font-size: 2rem"
                    ></i>
                    <span>Loading References</span>
                  </div>
                  <p-divider fxFlex class="title" align="center">
                    <small>National Reference</small>
                  </p-divider>
                  <div
                    *ngFor="let c of referenceControls.controls; let i = index"
                    fxFlex
                  >
                    <ng-container [formGroupName]="i">
                      <div class="p-field" fxFlex>
                        <span class="p-float-label">
                          <p-dropdown
                            *ngIf="!c.get('isMultiple')?.value"
                            id="section_id"
                            optionLabel="description"
                            [autoDisplayFirst]="false"
                            [filter]="true"
                            class="p-inputtext-sm"
                            appendTo="body"
                            dataKey="id"
                            [options]="c.get('options')?.value"
                            formControlName="value"
                          ></p-dropdown>
                          <p-multiSelect
                            *ngIf="c.get('isMultiple')?.value"
                            id="section_id"
                            optionLabel="description"
                            [filter]="true"
                            dataKey="id"
                            class="p-inputtext-sm"
                            appendTo="body"
                            [options]="c.get('options')?.value"
                            formControlName="value"
                          >
                          </p-multiSelect>

                          <label for="{{ i }}">{{
                            c.get("name")?.value!
                          }}</label>
                        </span>
                        <span
                          *ngIf="
                            c.get('value')!.invalid &&
                            (c.get('value')!.dirty ||
                              c.get('value')!.touched ||
                              formError)
                          "
                        >
                          <small
                            class="p-error"
                            *ngIf="c.get('value')?.errors?.required"
                            >{{ c.get("name")?.value! }} Value is
                            required.</small
                          >
                        </span>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </form>

            <div fxLayout="row" fxLayoutGap="0.75rem">
              <span fxFlex></span>
              <button
                matStepperPrevious
                class="p-button-text"
                icon="pi pi-arrow-left"
                iconPos="left"
                label="Back"
                pButton
                type="button"
              ></button>
              <button
                *ngIf="!budgetIsLocked"
                class="p-button-raised"
                icon="pi pi-check"
                label="Save"
                pButton
                type="submit"
              ></button>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </form>
  </div>
</div>

<p-confirmPopup key="deletePopup"></p-confirmPopup>

<p-overlayPanel
  #genericActivityPanel
  [dismissable]="false"
  [showCloseIcon]="true"
  appendTo="body"
>
  <ng-template pTemplate>
    <div style="width: 840px" fxLayout="column" fxLayoutGap="20px">
      <!-- Generic Target -->
      <div class="p-field" fxFlex>
        <span class="p-float-label">
          <p-dropdown
            id="genetic_target"
            optionLabel="description"
            [autoDisplayFirst]="false"
            (onChange)="prepareParams()"
            [filter]="true"
            dataKey="id"
            class="p-inputtext-sm"
            appendTo="body"
            [options]="genericActivities!"
            [(ngModel)]="genericActivity"
          ></p-dropdown>
          <label for="genetic_target">Generic Activity</label>
        </span>
        <span *ngIf="paramsError && !genericActivity">
          <small class="p-error">Generic activity is required.</small>
        </span>
      </div>
      <!-- Params -->
      <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
        <div class="p-field" fxFlex *ngFor="let p of params">
          <span class="p-float-label">
            <input
              id="code"
              type="text"
              pInputText
              [(ngModel)]="paramValues[p]"
            />
            <label for="code">{{ p }} </label>
          </span>
          <span *ngIf="paramsError && !paramValues[p]">
            <small class="p-error">{{ p }} value is required.</small>
          </span>
        </div>
      </div>
      <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="end">
        <button
          class="p-button-raised"
          icon="pi pi-check"
          label="Apply"
          (click)="createFromGeneric()"
          pButton
          pRipple
          type="button"
        ></button>
      </div>
    </div>
  </ng-template>
</p-overlayPanel>
