<div class="dialog-content">
  <div fxLayout="column" fxLayoutGap="20px">
    <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
      <button
        pButton
        class="p-button-sm p-button-outlined"
        icon="pi pi-clone"
        label="Generic Target"
        (click)="genericTargetPanel.toggle($event)"
      ></button>
    </div>
    <form
      name="editForm"
      role="form"
      novalidate
      (ngSubmit)="save()"
      [formGroup]="editForm"
    >
      <div fxLayout="column" fxLayoutGap="1rem">
        <div class="p-field p-col-12 p-md-4" fxFlex>
          <span class="p-float-label">
            <input
              id="description"
              type="text"
              pInputText
              formControlName="description"
            />
            <label for="description">Description </label>
          </span>
          <span
            *ngIf="
              editForm.get('description')!.invalid &&
              (editForm.get('description')!.dirty ||
                editForm.get('description')!.touched ||
                formError)
            "
          >
            <small
              class="p-error"
              *ngIf="editForm.get('description')?.errors?.required"
              >Description is required.</small
            >
          </span>
        </div>

        <div class="p-field" fxFlex>
          <span class="p-float-label">
            <p-dropdown
              id="objective_id"
              optionValue="id"
              optionLabel="description"
              [autoDisplayFirst]="false"
              [filter]="true"
              class="p-inputtext-sm"
              appendTo="body"
              [options]="objectives!"
              formControlName="objective_id"
            ></p-dropdown>
            <label for="objective_id">Objective </label>
          </span>
          <span
            *ngIf="
              editForm.get('objective_id')!.invalid &&
              (editForm.get('objective_id')!.dirty ||
                editForm.get('objective_id')!.touched ||
                formError)
            "
          >
            <small
              class="p-error"
              *ngIf="editForm.get('objective_id')?.errors?.required"
              >Objective is required.</small
            >
          </span>
        </div>
        <div class="p-field" fxFlex>
          <span class="p-float-label">
            <p-dropdown
              #sectionId
              id="section_id"
              optionValue="id"
              optionLabel="name"
              [autoDisplayFirst]="false"
              [filter]="true"
              class="p-inputtext-sm"
              (onChange)="
                loadReferences(sectionId.value, editForm.get('id')?.value)
              "
              appendTo="body"
              [options]="sections!"
              formControlName="section_id"
            ></p-dropdown>
            <label for="section_id">Section </label>
          </span>
          <span
            *ngIf="
              editForm.get('section_id')!.invalid &&
              (editForm.get('section_id')!.dirty ||
                editForm.get('section_id')!.touched ||
                formError)
            "
          >
            <small
              class="p-error"
              *ngIf="editForm.get('section_id')?.errors?.required"
              >Section is required.</small
            >
          </span>
        </div>
        <div
          formArrayName="references"
          fxLayout="column"
          fxLayoutGap="10px"
          fxLayoutAlign="start wrap"
        >
          <div
            *ngIf="referenceLoading"
            fxLayout="row"
            fxLayoutGap="10px"
            fxLayoutAlign="center center"
          >
            <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
            <span>Loading References</span>
          </div>
          <div
            *ngFor="let c of referenceControls.controls; let i = index"
            fxFlex
          >
            <ng-container [formGroupName]="i">
              <div class="p-field" fxFlex>
                <span class="p-float-label">
                  <p-dropdown
                    *ngIf="!c.get('isMultiple')?.value"
                    id="section_id"
                    optionLabel="description"
                    [autoDisplayFirst]="false"
                    [filter]="true"
                    class="p-inputtext-sm"
                    appendTo="body"
                    dataKey="id"
                    [options]="c.get('options')?.value"
                    formControlName="value"
                  ></p-dropdown>
                  <p-multiSelect
                    *ngIf="c.get('isMultiple')?.value"
                    id="section_id"
                    optionLabel="description"
                    [filter]="true"
                    dataKey="id"
                    class="p-inputtext-sm"
                    appendTo="body"
                    [options]="c.get('options')?.value"
                    formControlName="value"
                  >
                  </p-multiSelect>

                  <label for="{{ i }}">{{ c.get("name")?.value! }}</label>
                </span>
                <span
                  *ngIf="
                    c.get('value')!.invalid &&
                    (c.get('value')!.dirty ||
                      c.get('value')!.touched ||
                      formError)
                  "
                >
                  <small
                    class="p-error"
                    *ngIf="c.get('value')?.errors?.required"
                    >{{ c.get("name")?.value! }} Value is required.</small
                  >
                </span>
              </div>
            </ng-container>
          </div>
        </div>
        <div fxLayout="row" fxLayoutGap="0.75rem">
          <span fxFlex></span>
          <button
            class="p-button-raised"
            icon="pi pi-check"
            label="Save"
            [disabled]="referenceLoading"
            pButton
            pRipple
            type="submit"
          ></button>
        </div>
      </div>
    </form>
  </div>
</div>

<p-overlayPanel
  #genericTargetPanel
  [dismissable]="false"
  [showCloseIcon]="true"
  appendTo="body"
>
  <ng-template pTemplate>
    <div style="width: 840px" fxLayout="column" fxLayoutGap="20px">
      <!-- Departmrnty -->
      <div class="p-field" style="width: '40%'">
        <span class="p-float-label">
          <p-dropdown
            #genericTargetSection
            id="generic_target_section_id"
            optionValue="id"
            optionLabel="name"
            [autoDisplayFirst]="false"
            [filter]="true"
            class="p-inputtext-sm"
            (onChange)="loadGenerciTargets(genericTargetSection.value)"
            appendTo="body"
            [(ngModel)]="genericTargetSectionId"
            [options]="sections!"
          ></p-dropdown>
          <label for="generic_target_section_id">Department</label>
        </span>
      </div>
      <!-- Generic Target -->
      <div class="p-field" fxFlex>
        <span class="p-float-label">
          <p-dropdown
            id="genetic_target"
            optionLabel="description"
            [autoDisplayFirst]="false"
            (onChange)="prepareParams()"
            [filter]="true"
            dataKey="id"
            class="p-inputtext-sm"
            appendTo="body"
            [options]="genericTargets!"
            [(ngModel)]="genericTarget"
          ></p-dropdown>
          <label for="genetic_target">Generic Target</label>
        </span>
        <span *ngIf="paramsError && !genericTarget">
          <small class="p-error">Generic target is required.</small>
        </span>
      </div>
      <!-- Params -->
      <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="start">
        <div class="p-field" fxFlex *ngFor="let p of params">
          <span class="p-float-label">
            <input
              id="code"
              type="text"
              pInputText
              [(ngModel)]="paramValues[p]"
            />
            <label for="code">{{ p }} </label>
          </span>
          <span *ngIf="paramsError && !paramValues[p]">
            <small class="p-error">{{ p }} value is required.</small>
          </span>
        </div>
      </div>
      <div fxLayout="row" fxLayoutGap="10px" fxLayoutAlign="end">
        <button
          class="p-button-raised"
          icon="pi pi-check"
          label="Apply"
          (click)="createFromGeneric()"
          pButton
          pRipple
          type="button"
        ></button>
      </div>
    </div>
  </ng-template>
</p-overlayPanel>
